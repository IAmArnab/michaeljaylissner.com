<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Mike Lissner" />
        <meta name="copyright" content="Mike Lissner" />

        <link rel="author" href=https://plus.google.com/+MikeLissner />
        <meta name="twitter:creator" content="@mlissner">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Bulk Data, CourtListener, Tech, " />

<meta property="og:title" content="Updating Bulk Data in CourtListener…Again  - Can You Do it Faster? "/>
<meta property="og:url" content="https://michaeljaylissner.com/posts/2014/11/06/updating-bulk-data-in-courtlistener-more/" />
<meta property="og:description" content="I wrote a few weeks ago about our wonderful new bulk data system. It’s great, but not fast enough. Now it is." />
<meta property="og:site_name" content="Michael Jay Lissner" />
<meta property="og:article:author" content="Mike Lissner" />
<meta property="og:article:published_time" content="2014-11-06T00:00:00-08:00" />
<meta name="twitter:title" content="Updating Bulk Data in CourtListener…Again  - Can You Do it Faster? ">
<meta name="twitter:description" content="I wrote a few weeks ago about our wonderful new bulk data system. It’s great, but not fast enough. Now it is.">
<meta property="og:image" content="//localhost:8000/theme/images/apple-touch-icon-152x152.png" />
<meta name="twitter:image" content="//localhost:8000/theme/images/apple-touch-icon-152x152.png" >

        <title>Updating Bulk Data in CourtListener…Again  - Can You Do it Faster?  · Michael Jay Lissner
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://michaeljaylissner.com/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://michaeljaylissner.com/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://michaeljaylissner.com/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://michaeljaylissner.com/theme/css/custom.css" media="screen">
        <link rel="shortcut icon" href="https://michaeljaylissner.com/theme/images/favicon.ico" type="image/x-icon" type="image/png" />
        <link rel="icon" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="https://michaeljaylissner.com/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="https://michaeljaylissner.com/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link href="https://michaeljaylissner.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Michael Jay Lissner - Full Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-55828430-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <div class="span1"></div>
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="https://michaeljaylissner.com/"><span class=site-name>Michael Jay Lissner</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="https://michaeljaylissner.com">Home</a></li>
                                        <li ><a href="https://michaeljaylissner.com/about">About&nbsp;Site</a></li>
                                        <li ><a href="https://michaeljaylissner.com/contact">Contact</a></li>
                                        <li ><a href="https://michaeljaylissner.com/projects-and-papers">Projects <span class="amp">&amp;</span>&nbsp;Papers</a></li>
                            <li ><a href="https://michaeljaylissner.com/tags.html">Tags</a></li>
                            <li ><a href="https://michaeljaylissner.com/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="https://michaeljaylissner.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="https://michaeljaylissner.com/posts/2014/11/06/updating-bulk-data-in-courtlistener-more/"> Updating Bulk Data in&nbsp;CourtListener&#8230;Again  <small> Can You Do it Faster? </small>  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>I <a href="https://michaeljaylissner.com/posts/2014/09/28/updating-bulk-data-in-courtlistener/">wrote a few weeks ago</a> about our new system for creating <a href="https://www.courtlistener.com/api/bulk-info/">bulk files in CourtListener</a>. The system was pretty good. The goal was and is to efficiently create one bulk file for every jurisdiction&#8212;object pair in the system. So, that means one bulk file for oral arguments from Supreme Court, another for opinions from the Ninth Circuit of Appeals, another for dockets from Alabama&#8217;s appellate court, etc. We have about 350 jurisdictions and four different object types right now, for a total of about 1,400 bulk&nbsp;files.</p>
<p>This system needs to be&nbsp;fast.</p>
<p>The old system that I wrote about before would create 350 open file handles at a time, and then would iterate over each item in the database, adding it to the correct file as it inspected the item. This was a beautiful system because it only had to iterate over the database once, but even after <a href="https://github.com/freelawproject/courtlistener/commit/a0e4326d98e9f501ec3e69955d6b5650471686e8">performance tuning</a>, it still took about 24 hours. Not good&nbsp;enough. </p>
<p>I got to thinking that it was terrible to create the entire bulk archive over and over when in reality only a few items change each day. So I created a <a href="https://github.com/freelawproject/courtlistener/issues/293">bug to make bulk data creation incremental</a>. </p>
<p>This post is about that&nbsp;process.</p>
<h2 id="the-first-approach">The First&nbsp;Approach</h2>
<p>The obvious way to do this kind of thing is to grab the bulk files you already have (as gz-compressed tar files), and add the updated items to those files. Well, I wrote up code for this, tested it pretty thoroughly and considered it done. Only to realize that, like regular files, when you create a compressed tar file with a command like&nbsp;this&#8230;   </p>
<div class="highlight"><pre><span class="n">tar_files</span><span class="p">[</span><span class="s">&#39;all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;all.tar.gz&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w:gz&#39;</span><span class="p">)</span>
</pre></div>


<p>&#8230;it clobbers any old files that might have the same name. So much for&nbsp;that.</p>
<h2 id="next-approach">Next&nbsp;Approach</h2>
<p>Well, it looked like we needed append mode for compressed tar files, but alas, from <a href="https://docs.python.org/3/library/tarfile.html">the documentation</a>:</p>
<blockquote>
<p>Note that &#8216;a:gz&#8217;, &#8216;a:bz2&#8217; or &#8216;a:xz&#8217; is not&nbsp;possible.</p>
</blockquote>
<p><span class="dquo">&#8220;</span>a:gz&#8221; means a gz-compressed tar file in <strong>a</strong>ppend mode, so much for that idea.&nbsp;Next! </p>
<h2 id="next-approach_1">Next&nbsp;Approach</h2>
<p>Well, you can&#8217;t make gz-compressed tar files in append mode, but you can create tar files in append mode as step one, then compress them as step two. I tried this next, and again, it looked like it was working&#8230;until I realized that my tar files contained copy after copy after copy of each file. I was hoping that it&#8217;d simply clobber files that were previously in the file, but instead it was just putting multiple files of the same name into the&nbsp;tar. </p>
<p>Perhaps I can delete from the tar file before adding items back to it? <a href="http://bytes.com/topic/python/answers/40408-deleting-tarfile">Nope, that&#8217;s not possible either</a>. Next&nbsp;idea?</p>
<h2 id="final-approach">Final&nbsp;Approach</h2>
<p>I was feeling pretty frustrated by now, but there was one more approach, and that was to add an intermediate step. Instead of creating the tar files directly in Python, I could save the individual <code>json</code> files I was previously putting into the tar file to disk, then create the compressed tar files directly from those once they&#8217;re all created. We proved earlier that Python has no issues about clobbering items on disk, so that&#8217;ll work nicely for incremental bulk files, which will just clobber old versions of the&nbsp;files.</p>
<p>From performance analyses of the code, most of the bottleneck is in serializing <span class="caps">JSON</span>, so this will change it so that gets done at most once per item in the database and then most of the remaining work will be making tar files and gz-compressing&nbsp;them. </p>
<h2 id="whew">Whew!</h2>
<p>I was hoping that I would be able to easily update items inside a compressed tar file, or even inside an uncompressed tar file, but that doesn&#8217;t seem&nbsp;possible. </p>
<p>I was hoping that I could create these files while iterating over the database, as described in the first approach, but that&#8217;s not doable&nbsp;either. </p>
<p>At the end of the day, the final method is just to write things to disk. Simple beats complicated this time, even when it comes to&nbsp;performance. </p>
            
            <section>
<p id="comment-message">I love getting feedback and comments. Make my day by making a comment. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="https://michaeljaylissner.com/posts/2014/11/06/updating-bulk-data-in-courtlistener-more/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'michaeljaylissner';
        var disqus_identifier = 'https://michaeljaylissner.com/posts/2014/11/06/updating-bulk-data-in-courtlistener-more/';
    var disqus_url = 'https://michaeljaylissner.com/posts/2014/11/06/updating-bulk-data-in-courtlistener-more/';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="https://michaeljaylissner.com/posts/2014/11/01/some-thoughts-on-celery/" title="Previous: Some Thoughts on Celery - A love-hate relationship">Some Thoughts on Celery <small>A love-hate relationship</small></a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-11-06T00:00:00-08:00">Nov 6, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="https://michaeljaylissner.com/categories.html#tech-ref">Tech</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://michaeljaylissner.com/tags.html#bulk-data-ref">Bulk Data
                    <span>3</span>
</a></li>
                <li><a href="https://michaeljaylissner.com/tags.html#courtlistener-ref">CourtListener
                    <span>17</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://twitter.com/mlissner" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="http://github.com/mlissner" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="mailto:mlissner+blog@michaeljaylissner.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
<h4>This is Reader-Editable</h4>
<a href="https://github.com/mlissner/michaeljaylissner.com/edit/master/content/updating-bulk-data-in-courtlistener-more.md">
    <i class="fa fa-github"></i>
    Edit this post on Github
</a><!-- Begin MailChimp Signup Form -->
<div id="mc-embed-signup">
<form action="//asdf.us2.list-manage.com/subscribe/post?u=87204b44efb46f0fd27b95167&amp;id=f511375e11" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
<h4>Get Weekly Updates</h4>
<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Enter your email..." required>
<div class="clear"><input type="submit" value="Send Me Updates" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
</form>
</div>
<!--End mc_embed_signup-->
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">Unless mentioned otherwise, all material on this site is <a href="about#license">licensed</a> under a Creative Commons copyright or the GNU Affero GPL. <a href="about#privacy">Privacy Policy</a>.</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'michaeljaylissner';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>